name: Generate Family Guy Short

on:
  workflow_dispatch:
    inputs:
      script_file:
        description: 'Script file path'
        required: false
        default: 'config/scripts/EPISODE_01.txt'

jobs:
  create-short:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: UTC
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ffmpeg imagemagick fonts-dejavu-core
      
      - name: Fix ImageMagick security policy
        run: |
          # Allow ImageMagick to read @file references (needed by MoviePy TextClip)
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml
          # Also remove any PDF/PS restrictions that might interfere
          sudo sed -i 's/<policy domain="coder" rights="none" pattern="PDF"/<policy domain="coder" rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create directories
        run: |
          mkdir -p assets audio output
      
      - name: Generate ALL Audio (Voices via HeartMuLa)
        env:
          MODAL_ENDPOINT: ${{ secrets.MODAL_ENDPOINT }}
          SCRIPT_PATH: ${{ github.event.inputs.script_file }}
        run: |
          echo "ðŸŽµ Starting audio generation..."
          python scripts/generate_audio.py
      
      - name: Verify audio files
        run: |
          echo "ðŸ“Š Audio files generated:"
          ls -la audio/
          echo "Total WAV files: $(ls audio/*.wav 2>/dev/null | wc -l)"
          cat audio/metadata.json || echo "No metadata file"
      
      - name: Assemble Video (with characters + layout)
        env:
          SCRIPT_PATH: ${{ github.event.inputs.script_file }}
        run: |
          echo "ðŸŽ¬ Assembling professional video..."
          python scripts/assemble_video.py
      
      - name: Add Auto-Captions
        run: |
          echo "ðŸ“ Adding captions..."
          python scripts/add_captions.py
      
      - name: Verify final output
        run: |
          echo "âœ… Final video stats:"
          ffprobe -v error -show_entries format=duration,size -of default=noprint_wrappers=1 output/final_reel.mp4
          ffprobe -v error -show_entries stream=width,height -of default=noprint_wrappers=1 output/final_reel.mp4
          ls -lh output/
      
      - name: Upload final video
        uses: actions/upload-artifact@v4
        with:
          name: family-guy-short-${{ github.run_number }}
          path: output/final_reel.mp4
          retention-days: 30

      - name: Upload audio files
        uses: actions/upload-artifact@v4
        with:
          name: audio-files-${{ github.run_number }}
          path: audio/
          retention-days: 30
      
      - name: Create summary
        run: |
          echo "## ðŸŽ¬ Video Generated Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Script:** ${{ github.event.inputs.script_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Format:** 1080x1920 (Instagram Reel)" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** Click on the artifacts above â¬†ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh audio/ output/ 2>/dev/null >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY