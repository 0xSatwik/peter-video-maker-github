name: Generate Family Guy Short

on:
  workflow_dispatch:
    inputs:
      colab_url:
        description: 'Colab Gradio URL (e.g. https://xxxxx.gradio.live)'
        required: true
      script_file:
        description: 'Script file path'
        required: false
        default: 'config/scripts/EPISODE_01.txt'

jobs:
  create-short:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: UTC
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            ffmpeg \
            imagemagick \
            fonts-dejavu-core \
            fonts-noto \
            fonts-roboto \
            fonts-open-sans \
            fonts-montserrat \
            fonts-cantarell
      
      - name: Fix ImageMagick security policy
        run: |
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml
          sudo sed -i 's/<policy domain="coder" rights="none" pattern="PDF"/<policy domain="coder" rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create directories
        run: mkdir -p audio output
      
      - name: Generate Voice Audio (via Colab MOSS-TTS)
        env:
          COLAB_URL: ${{ github.event.inputs.colab_url }}
          SCRIPT_PATH: ${{ github.event.inputs.script_file }}
        run: python scripts/generate_audio.py
      
      - name: Verify audio files
        run: |
          echo "ðŸ“Š Audio files generated:"
          ls -lh audio/ || echo "No audio directory"
          echo ""
          echo "Total WAV files: $(ls audio/*.wav 2>/dev/null | wc -l)"
          echo ""
          echo "ðŸ“‹ Metadata:"
          cat audio/metadata.json | python3 -m json.tool || echo "No metadata"
          echo ""
          echo "ðŸ“ Character images in assets/:"
          ls -lh assets/*.png assets/*.jpg 2>/dev/null || echo "No images found"
          echo ""
          echo "ðŸŽ¬ Background video:"
          ffprobe -v error -show_entries format=duration:stream=width,height -of json assets/minecraft_bg.mp4 2>/dev/null || echo "No bg video"
      
      - name: Assemble Video
        env:
          SCRIPT_PATH: ${{ github.event.inputs.script_file }}
          PYTHONUNBUFFERED: '1'
        run: python -u scripts/assemble_video.py
      
      - name: Add Captions
        env:
          PYTHONUNBUFFERED: '1'
        run: python -u scripts/add_captions.py
      
      - name: Verify final output
        run: |
          echo "âœ… Final video:"
          ffprobe -v error -show_entries format=duration,size -of default=noprint_wrappers=1 output/final_reel.mp4
          ffprobe -v error -show_entries stream=width,height -of default=noprint_wrappers=1 output/final_reel.mp4
          ls -lh output/
      
      - name: Upload final video
        uses: actions/upload-artifact@v4
        with:
          name: family-guy-short-${{ github.run_number }}
          path: output/final_reel.mp4
          retention-days: 30

      - name: Upload audio files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audio-files-${{ github.run_number }}
          path: |
            audio/*.wav
            audio/metadata.json
          retention-days: 30
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸŽ¬ Video Generated Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Script:** ${{ github.event.inputs.script_file }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Colab:** ${{ github.event.inputs.colab_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Format:** 1080x1920 (Instagram Reel)" >> $GITHUB_STEP_SUMMARY